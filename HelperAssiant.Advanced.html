<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Helper Assistant ‚Äî Advanced</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f1724; --accent:#6ee7b7; --muted:#9aa4b2;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    background:linear-gradient(180deg,#041021 0%, #07142b 100%);
    color:#e6eef3; display:flex; align-items:flex-start; justify-content:center; padding:24px;
  }
  .app{
    width:100%; max-width:940px; background:var(--panel); border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.6); overflow:hidden;
  }
  header{
    padding:18px 20px; display:flex; gap:12px; align-items:center; border-bottom:1px solid rgba(255,255,255,0.03);
  }
  header h1{margin:0;font-size:18px;letter-spacing:0.2px}
  .controls{padding:14px 20px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);}
  input[type="text"], textarea{
    width:100%; max-width:680px; background:var(--glass); border:1px solid rgba(255,255,255,0.03); color:inherit; padding:10px 12px; border-radius:8px; font-size:14px;
  }
  .row{display:flex; gap:10px; align-items:center; width:100%;}
  button{
    background:linear-gradient(180deg,var(--accent), #23b78f); color:#032a1c; border:none; padding:10px 14px; border-radius:9px; font-weight:700; cursor:pointer;
    box-shadow:0 6px 18px rgba(17,154,123,0.12);
  }
  button.ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); box-shadow:none;}
  label.toggle{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:13px;}
  main{display:flex; gap:18px; padding:18px; align-items:flex-start;}
  .left{flex:1; min-width:260px;}
  .right{width:420px; max-width:46%; min-width:260px;}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03);}
  .messages{height:56vh; overflow:auto; padding:10px; display:flex; flex-direction:column; gap:8px;}
  .msg{padding:10px 12px; border-radius:10px; max-width:92%; line-height:1.4;}
  .msg.assistant{background:rgba(13,38,51,0.55); align-self:flex-start; color:#dffaf0;}
  .msg.user{background:rgba(255,255,255,0.03); align-self:flex-end; color:#cfe8ff;}
  .meta{font-size:12px;color:var(--muted); margin-top:6px;}
  .source{font-size:13px;color:var(--accent); display:block; margin-top:8px; word-break:break-word;}
  .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:10px;}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,#7ef0c7,#2fb38f);}
  footer{padding:12px 18px;border-top:1px solid rgba(255,255,255,0.02); display:flex; gap:12px; align-items:center; justify-content:space-between;}
  small{color:var(--muted);}
  a.link{color:var(--accent); text-decoration:none;}
  .kbd{display:inline-block;background:rgba(255,255,255,0.02);padding:2px 6px;border-radius:6px;font-family:monospace;font-size:12px;margin-left:6px;color:var(--muted);}
  @media(max-width:880px){main{flex-direction:column}.right{max-width:none;width:100%}}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Helper Assistant">
  <header>
    <h1>ü§ñ Helper Assistant (Advanced)</h1>
    <small style="margin-left:auto;color:var(--muted)">Math ‚Ä¢ Web research ‚Ä¢ Speak ‚Ä¢ Step-by-step</small>
  </header>

  <div class="controls">
    <div style="flex:1; min-width:220px;">
      <input id="queryInput" type="text" placeholder="Ask anything, or paste a math expression (e.g. 12*3+(4^2)/2) ‚Äî try: help me, I scanned the game pak and it isn't working!">
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="askBtn">Ask</button>
      <button id="calcBtn" class="ghost">Calculate</button>
      <button id="researchBtn" class="ghost">Research (web)</button>
    </div>

    <div style="margin-left:8px;display:flex;gap:8px;align-items:center">
      <label class="toggle"><input id="thinkLong" type="checkbox"> Think longer</label>
      <label class="toggle"><input id="voiceToggle" type="checkbox"> Speak</label>
    </div>
  </div>

  <main>
    <section class="left">
      <div class="panel">
        <div class="messages" id="messages" aria-live="polite"></div>
      </div>

      <footer>
        <small>Tip: Try math, or type questions like <em>what is CPU</em> or the GamePak question.</small>
        <div><span class="kbd">Enter</span> to send</div>
      </footer>
    </section>

    <aside class="right">
      <div class="panel">
        <h3 style="margin:0 0 8px 0">Session</h3>
        <div class="meta">You can:</div>
        <ul style="color:var(--muted); margin-top:8px">
          <li>Ask for calculations ‚Äî step-by-step math is shown.</li>
          <li>Research topics (uses Wikipedia + DuckDuckGo fallback).</li>
          <li>Toggle "Think longer" for expanded, structured answers.</li>
        </ul>
        <div style="margin-top:12px">
          <strong>GamePak help quick phrase</strong>
          <div class="meta">Ask: <em>help me, I scanned the game pak and it isn't working! Can you help me?</em></div>
        </div>
        <div style="margin-top:12px">
          <strong>Sources:</strong>
          <div class="meta">Wikipedia + DuckDuckGo (if available). Always includes source links when available.</div>
        </div>
      </div>
    </aside>
  </main>
</div>

<script>
/* ------------------------
   Utilities & UI helpers
   ------------------------ */
const messagesEl = document.getElementById('messages');
const queryInput = document.getElementById('queryInput');
const askBtn = document.getElementById('askBtn');
const calcBtn = document.getElementById('calcBtn');
const researchBtn = document.getElementById('researchBtn');
const thinkLong = document.getElementById('thinkLong');
const voiceToggle = document.getElementById('voiceToggle');

function addMessage(role, text, extraHtml='') {
  const d = document.createElement('div');
  d.className = 'msg ' + (role==='user' ? 'user' : 'assistant');
  d.innerHTML = `<div>${escapeHtml(text)}</div>${extraHtml||''}`;
  messagesEl.appendChild(d);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function addRawMessage(role, html) {
  const d = document.createElement('div');
  d.className = 'msg ' + (role==='user' ? 'user' : 'assistant');
  d.innerHTML = html;
  messagesEl.appendChild(d);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[ch])); }
function speak(text){
  if(!voiceToggle.checked) return;
  if('speechSynthesis' in window){
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US';
    u.rate = 1;
    u.pitch = 1;
    speechSynthesis.speak(u);
  }
}

/* ------------------------
   GamePak help exact reply
   ------------------------ */
const gamePakHelpReply = `Check The README File For 2 Tips, if you're lazy, I can do it!<br><br>
Download The File, if you already did it, that's like finished step 1!<br><br>
Steps: open the file you downloaded, scan your game pak in the USB Port... And Vooala!<br><br>
If you need anything just talk to me!`;

/* ------------------------
   Math: tokenizer, shunting-yard, evaluator with steps
   ------------------------ */
const FUNCTIONS = new Set(['sin','cos','tan','sqrt','abs','log','ln']);
const CONSTANTS = { 'pi': Math.PI, 'e': Math.E };

const OPERATORS = {
  '+': {prec:2,assoc:'L',arity:2,fn:(a,b)=>a+b},
  '-': {prec:2,assoc:'L',arity:2,fn:(a,b)=>a-b},
  '*': {prec:3,assoc:'L',arity:2,fn:(a,b)=>a*b},
  '/': {prec:3,assoc:'L',arity:2,fn:(a,b)=>a/b},
  '%': {prec:3,assoc:'L',arity:2,fn:(a,b)=>a%b},
  '^': {prec:4,assoc:'R',arity:2,fn:(a,b)=>Math.pow(a,b)},
  'u-': {prec:5,assoc:'R',arity:1,fn:(a)=>-a}
};

function tokenize(expr){
  expr = expr.replace(/\s+/g,'');
  const regex = /([0-9]*\.?[0-9]+|pi|e|[A-Za-z_][A-Za-z0-9_]*|[\+\-\*\/\^\%ÓÄÅÓÄÅ,])/g;
  let m, tokens=[];
  let idx=0;
  while((m = regex.exec(expr)) !== null){
    let t = m[1];
    // detect unary minus
    if(t === '-' ){
      const prev = tokens.length ? tokens[tokens.length-1] : null;
      if(prev === null || (prev === '(') || (prev in OPERATORS) || prev === ','){
        t = 'u-';
      }
    }
    tokens.push(t);
    idx = regex.lastIndex;
  }
  // Basic validation
  if(tokens.length===0) throw new Error('No tokens found');
  return tokens;
}

function infixToPostfix(tokens){
  const out = [];
  const stack = [];
  for(let i=0;i<tokens.length;i++){
    const t = tokens[i];
    if(!isNaN(t)){
      out.push({type:'number', value: parseFloat(t)});
    } else if(t.toLowerCase() in CONSTANTS){
      out.push({type:'number', value: CONSTANTS[t.toLowerCase()]});
    } else if(FUNCTIONS.has(t.toLowerCase())){
      stack.push({type:'func', value: t.toLowerCase()});
    } else if(t === ','){
      while(stack.length && stack[stack.length-1].value !== '('){
        out.push(stack.pop());
      }
      if(!stack.length) throw new Error('Misplaced comma or parentheses');
    } else if(t in OPERATORS){
      const o1 = t;
      while(stack.length){
        const top = stack[stack.length-1];
        if(top.type === 'op'){
          const o2 = top.value;
          const cond = (OPERATORS[o1].assoc === 'L' && OPERATORS[o1].prec <= OPERATORS[o2].prec)
                    || (OPERATORS[o1].assoc === 'R' && OPERATORS[o1].prec < OPERATORS[o2].prec);
          if(cond){
            out.push(stack.pop());
            continue;
          }
        }
        break;
      }
      stack.push({type:'op', value:o1});
    } else if(t === '('){
      stack.push({type:'paren', value:'('});
    } else if(t === ')'){
      while(stack.length && stack[stack.length-1].value !== '('){
        out.push(stack.pop());
      }
      if(!stack.length) throw new Error('Mismatched parentheses');
      stack.pop(); // remove '('
      if(stack.length && stack[stack.length-1].type === 'func'){
        out.push(stack.pop());
      }
    } else {
      throw new Error('Unknown token: ' + t);
    }
  }
  while(stack.length){
    const top = stack.pop();
    if(top.value === '(' || top.value === ')') throw new Error('Mismatched parentheses');
    out.push(top);
  }
  return out;
}

function evalPostfix(postfix){
  const stack = [];
  const steps = [];
  let stepCount = 1;
  for(const token of postfix){
    if(token.type === 'number'){
      stack.push(token.value);
    } else if(token.type === 'func'){
      if(stack.length < 1) throw new Error('Not enough args for function ' + token.value);
      const a = stack.pop();
      let res;
      switch(token.value){
        case 'sin': res = Math.sin(a); break;
        case 'cos': res = Math.cos(a); break;
        case 'tan': res = Math.tan(a); break;
        case 'sqrt': res = Math.sqrt(a); break;
        case 'abs': res = Math.abs(a); break;
        case 'log': res = Math.log10 ? Math.log10(a) : Math.log(a)/Math.LN10; break;
        case 'ln': res = Math.log(a); break;
        default: throw new Error('Unsupported function ' + token.value);
      }
      steps.push(`${stepCount++}. ${token.value}(${a}) = ${res}`);
      stack.push(res);
    } else if(token.type === 'op'){
      const op = token.value;
      if(OPERATORS[op].arity === 1){
        if(stack.length < 1) throw new Error('Not enough operands for ' + op);
        const a = stack.pop();
        const r = OPERATORS[op].fn(a);
        steps.push(`${stepCount++}. ${op === 'u-' ? '-' + a : op+'('+a+')'} = ${r}`);
        stack.push(r);
      } else {
        if(stack.length < 2) throw new Error('Not enough operands for ' + op);
        const b = stack.pop();
        const a = stack.pop();
        const r = OPERATORS[op].fn(a,b);
        steps.push(`${stepCount++}. ${a} ${op} ${b} = ${r}`);
        stack.push(r);
      }
    } else {
      throw new Error('Unknown postfix token');
    }
  }
  if(stack.length !== 1) throw new Error('Invalid expression');
  return { result: stack[0], steps };
}

/* Try parse & evaluate expression (returns {result, steps}) or throws */
function calculateExpression(expr){
  const tokens = tokenize(expr);
  const postfix = infixToPostfix(tokens);
  return evalPostfix(postfix);
}

/* ------------------------
   Web research (Wikipedia + DuckDuckGo fallback)
   ------------------------ */
async function searchWikipedia(q){
  // search list
  const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(q)}&utf8=&format=json&origin=*`;
  const r = await fetch(searchUrl);
  if(!r.ok) throw new Error('Wikipedia search failed');
  const j = await r.json();
  if(j.query && j.query.search && j.query.search.length>0){
    const title = j.query.search[0].title;
    const summaryUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
    const sres = await fetch(summaryUrl);
    if(sres.ok){
      const sjson = await sres.json();
      return {source:'wikipedia', title, extract: sjson.extract, url: 'https://en.wikipedia.org/wiki/' + encodeURIComponent(title)};
    }
  }
  return null;
}

async function duckDuckGoInstant(q){
  const ddg = `https://api.duckduckgo.com/?q=${encodeURIComponent(q)}&format=json&no_html=1&skip_disambig=1`;
  const r = await fetch(ddg);
  if(!r.ok) return null;
  const j = await r.json();
  if(j.AbstractText && j.AbstractText.length>0){
    return {source:'duckduckgo', title: q, extract: j.AbstractText, url: `https://duckduckgo.com/?q=${encodeURIComponent(q)}`};
  }
  // try related topics first text
  if(j.RelatedTopics && j.RelatedTopics.length > 0){
    const t = j.RelatedTopics[0];
    if(t.Text){
      return {source:'duckduckgo', title:q, extract:t.Text, url: `https://duckduckgo.com/?q=${encodeURIComponent(q)}`};
    }
  }
  return null;
}

async function webResearch(query){
  // try Wikipedia
  try{
    const wp = await searchWikipedia(query);
    if(wp) return wp;
  }catch(e){
    // ignore and fallback
    console.warn('wikipedia error', e);
  }
  // duckduckgo fallback
  try{
    const dd = await duckDuckGoInstant(query);
    if(dd) return dd;
  }catch(e){
    console.warn('ddg error', e);
  }
  return null;
}

/* ------------------------
   Main handlers
   ------------------------ */
async function handleAsk(){
  const raw = queryInput.value.trim();
  if(!raw) return;
  addMessage('user', raw);
  // detect the exact GamePak help phrase (or close variants)
  const normalized = raw.toLowerCase();
  if(normalized.includes("help me") && normalized.includes("game pak")){
    // reply with the exact requested message
    const html = `<strong>Helper Assistant:</strong><br><br>${gamePakHelpReply}`;
    addRawMessage('assistant', html);
    speak(stripHtml(gamePakHelpReply));
    queryInput.value='';
    return;
  }

  // detect math: presence of digits and operator characters is a heuristic
  if(looksLikeMath(raw)){
    try{
      const expr = extractMathExpression(raw);
      addRawMessage('assistant', `<strong>Helper Assistant
